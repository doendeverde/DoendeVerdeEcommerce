generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Account {
  id                String  @id @default(uuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Address {
  id           String   @id @default(uuid())
  userId       String
  label        String?
  street       String
  number       String
  complement   String?
  neighborhood String
  city         String
  state        String
  zipCode      String
  country      String   @default("BR")
  isDefault    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, isDefault])
}

model Cart {
  id        String     @id @default(uuid())
  userId    String     @unique
  status    CartStatus @default(ACTIVE)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     CartItem[]

  @@index([status])
}

model CartItem {
  id             String          @id @default(uuid())
  cartId         String
  productId      String
  variantId      String?
  quantity       Int
  unitPrice      Decimal         @db.Decimal(10, 2)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  cart           Cart            @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product        Product         @relation(fields: [productId], references: [id])
  variant        ProductVariant? @relation(fields: [variantId], references: [id])

  @@index([cartId])
  @@index([productId])
}

model Category {
  id           String    @id @default(uuid())
  name         String
  slug         String    @unique
  description  String?
  imageUrl     String?
  isActive     Boolean   @default(true)
  displayOrder Int       @default(0)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  products     Product[]

  @@index([isActive])
  @@index([slug])
}

model Coupon {
  id            String          @id @default(uuid())
  code          String          @unique
  type          DiscountType
  value         Decimal         @db.Decimal(10, 2)
  active        Boolean         @default(true)
  startsAt      DateTime?
  endsAt        DateTime?
  usageLimit    Int             @default(0)
  usedCount     Int             @default(0)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  discounts     OrderDiscount[]

  @@index([active])
  @@index([code])
}

model Order {
  id              String                @id @default(uuid())
  userId          String
  status          OrderStatus           @default(PENDING)
  subtotalAmount  Decimal               @db.Decimal(10, 2)
  discountAmount  Decimal               @default(0) @db.Decimal(10, 2)
  shippingAmount  Decimal               @default(0) @db.Decimal(10, 2)
  totalAmount     Decimal               @db.Decimal(10, 2)
  shippingData    Json?
  currency        String                @default("BRL")
  notes           String?
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  user            User                  @relation(fields: [userId], references: [id])
  addressSnapshot OrderAddressSnapshot?
  discounts       OrderDiscount[]
  items           OrderItem[]
  payments        Payment[]
  refunds         Refund[]
  shipments       Shipment[]
  shippingInfo    OrderShippingInfo?

  @@index([status])
  @@index([userId])
}

model OrderAddressSnapshot {
  id           String   @id @default(uuid())
  orderId      String   @unique
  fullName     String
  whatsapp     String
  street       String
  number       String
  complement   String?
  neighborhood String
  city         String
  state        String
  zipCode      String
  country      String   @default("BR")
  createdAt    DateTime @default(now())
  order        Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
}

model OrderDiscount {
  id        String       @id @default(uuid())
  orderId   String
  couponId  String?
  type      DiscountType
  amount    Decimal      @db.Decimal(10, 2)
  createdAt DateTime     @default(now())
  coupon    Coupon?      @relation(fields: [couponId], references: [id])
  order     Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([couponId])
  @@index([orderId])
}

model OrderItem {
  id             String          @id @default(uuid())
  orderId        String
  productId      String
  variantId      String?
  title          String
  sku            String?
  quantity       Int
  unitPrice      Decimal         @db.Decimal(10, 2)
  totalPrice     Decimal         @db.Decimal(10, 2)
  createdAt      DateTime        @default(now())
  order          Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product        Product         @relation(fields: [productId], references: [id])
  variant        ProductVariant? @relation(fields: [variantId], references: [id])

  @@index([orderId])
  @@index([productId])
}

model Payment {
  id            String              @id @default(uuid())
  orderId       String
  status        PaymentStatus       @default(PENDING)
  provider      PaymentProvider
  amount        Decimal             @db.Decimal(10, 2)
  transactionId String?
  payload       Json?
  // PIX-specific fields for recovery
  pixQrCode     String?             @db.Text
  pixQrCodeBase64 String?           @db.Text
  pixTicketUrl  String?
  pixExpiresAt  DateTime?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  order         Order               @relation(fields: [orderId], references: [id], onDelete: Cascade)
  refunds       Refund[]
  cycles        SubscriptionCycle[]

  @@index([orderId])
  @@index([status])
}

model Product {
  id                   String                @id @default(uuid())
  name                 String
  slug                 String                @unique
  description          String
  basePrice            Decimal               @db.Decimal(10, 2)
  stock                Int                   @default(0)
  stockMode            StockMode             @default(SIMPLE)
  categoryId           String
  shippingProfileId    String?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  isPublished          Boolean               @default(true)
  lowStockAlert        Int                   @default(5)
  loyaltyPoints        Int                   @default(0)
  status               ProductStatus         @default(ACTIVE)
  /// Soft delete timestamp - quando preenchido, produto está "excluído"
  deletedAt            DateTime?
  cartItems            CartItem[]
  orderItems           OrderItem[]
  category             Category              @relation(fields: [categoryId], references: [id])
  shippingProfile      ShippingProfile?      @relation(fields: [shippingProfileId], references: [id])
  images               ProductImage[]
  options              ProductOption[]
  tags                 ProductTag[]
  variants             ProductVariant[]
  reviews              Review[]
  stockMovements       StockMovement[]
  subscriptionProducts SubscriptionProduct[]

  @@index([categoryId])
  @@index([categoryId, isPublished, status])
  @@index([isPublished])
  @@index([shippingProfileId])
  @@index([slug])
  @@index([status])
  /// Index para queries de soft delete - otimiza filtro deletedAt IS NULL
  @@index([deletedAt])
}

model ProductImage {
  id           String   @id @default(uuid())
  productId    String
  url          String
  altText      String?
  displayOrder Int      @default(0)
  isPrimary    Boolean  @default(false)
  width        Int?
  height       Int?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  product      Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([isPrimary])
  @@index([productId])
}

model ProductOption {
  id        String               @id @default(uuid())
  productId String
  name      String
  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt
  product   Product              @relation(fields: [productId], references: [id], onDelete: Cascade)
  values    ProductOptionValue[]

  @@index([productId])
}

model ProductOptionValue {
  id           String               @id @default(uuid())
  optionId     String
  value        String
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  option       ProductOption        @relation(fields: [optionId], references: [id], onDelete: Cascade)
  optionValues VariantOptionValue[]

  @@index([optionId])
}

model ProductTag {
  id        String  @id @default(uuid())
  productId String
  tagId     String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  tag       Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([productId, tagId])
  @@index([productId])
  @@index([tagId])
}

model ProductVariant {
  id             String               @id @default(uuid())
  productId      String
  sku            String               @unique
  name           String
  price          Decimal?             @db.Decimal(10, 2)
  stock          Int                  @default(0)
  active         Boolean              @default(true)
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  cartItems      CartItem[]
  orderItems     OrderItem[]
  product        Product              @relation(fields: [productId], references: [id], onDelete: Cascade)
  stockMovements StockMovement[]
  optionValues   VariantOptionValue[]

  @@index([active])
  @@index([productId])
  @@index([sku])
}

model Refund {
  id               String   @id @default(uuid())
  paymentId        String
  orderId          String
  amount           Decimal  @db.Decimal(10, 2)
  reason           String?
  providerRefundId String?
  createdAt        DateTime @default(now())
  order            Order    @relation(fields: [orderId], references: [id])
  payment          Payment  @relation(fields: [paymentId], references: [id])

  @@index([orderId])
  @@index([paymentId])
}

model Review {
  id        String   @id @default(uuid())
  userId    String
  productId String
  rating    Int
  comment   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  product   Product  @relation(fields: [productId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@index([productId])
  @@index([rating])
  @@index([userId])
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Shipment {
  id           String         @id @default(uuid())
  orderId      String
  status       ShipmentStatus @default(PENDING)
  carrier      String?
  trackingCode String?
  shippedAt    DateTime?
  deliveredAt  DateTime?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  order        Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([status])
}

model StockMovement {
  id        String            @id @default(uuid())
  productId String
  variantId String?
  type      StockMovementType
  quantity  Int
  reason    String?
  createdAt DateTime          @default(now())
  product   Product           @relation(fields: [productId], references: [id])
  variant   ProductVariant?   @relation(fields: [variantId], references: [id])

  @@index([productId])
  @@index([type])
  @@index([variantId])
}

model Subscription {
  id                  String              @id @default(uuid())
  userId              String
  planId              String
  status              SubscriptionStatus  @default(ACTIVE)
  startedAt           DateTime
  nextBillingAt       DateTime
  canceledAt          DateTime?
  provider            PaymentProvider?
  providerSubId       String?             @unique // UNIQUE para prevenir race condition e duplicatas
  // Novos campos para melhor controle
  pausedAt            DateTime?           // Quando foi pausada
  cancelRequestedAt   DateTime?           // Quando solicitou cancelamento
  cancelReason        String?             // Motivo do cancelamento
  currentPeriodStart  DateTime?           // Início do período atual
  currentPeriodEnd    DateTime?           // Fim do período atual (quando expira)
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  plan                SubscriptionPlan    @relation(fields: [planId], references: [id])
  user                User                @relation(fields: [userId], references: [id])
  cycles              SubscriptionCycle[]

  @@index([planId])
  @@index([status])
  @@index([userId])
  @@index([providerSubId]) // Index para buscas rápidas por providerSubId
}

model SubscriptionCycle {
  id             String       @id @default(uuid())
  subscriptionId String
  status         CycleStatus  @default(PENDING)
  cycleStart     DateTime
  cycleEnd       DateTime
  amount         Decimal      @db.Decimal(10, 2)
  paymentId      String?
  createdAt      DateTime     @default(now())
  payment        Payment?     @relation(fields: [paymentId], references: [id])
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([subscriptionId])
}

model SubscriptionPlan {
  id                String                @id @default(uuid())
  name              String
  slug              String                @unique
  description       String?
  shortDescription  String?
  price             Decimal               @db.Decimal(10, 2)
  discountPercent   Int                   @default(0) // Percentual de desconto em produtos (0-100)
  billingCycle      BillingCycle          @default(MONTHLY)
  colorScheme       Json?                 // { primary, text, primaryDark, textDark, badge } - cores do plano
  active            Boolean               @default(true)
  isFeatured        Boolean               @default(false)
  shippingProfileId String?
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  subscriptions     Subscription[]
  products          SubscriptionProduct[]
  shippingProfile   ShippingProfile?      @relation(fields: [shippingProfileId], references: [id])
  planBenefits      PlanBenefit[]

  @@index([active])
  @@index([slug])
  @@index([isFeatured])
}

model SubscriptionProduct {
  id        String           @id @default(uuid())
  planId    String
  productId String
  quantity  Int              @default(1)
  plan      SubscriptionPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  product   Product          @relation(fields: [productId], references: [id])

  @@unique([planId, productId])
  @@index([planId])
  @@index([productId])
}

// ==========================================
// BENEFÍCIOS DE ASSINATURA
// ==========================================

model Benefit {
  id           String        @id @default(uuid())
  name         String        // Ex: "Frete Grátis"
  slug         String        @unique // Ex: "frete-gratis"
  description  String?       // Descrição longa
  icon         String?       // Ícone lucide: "Truck", "Percent", etc.
  isActive     Boolean       @default(true)
  displayOrder Int           @default(0)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  planBenefits PlanBenefit[]

  @@index([isActive])
  @@index([slug])
}

model PlanBenefit {
  id          String           @id @default(uuid())
  planId      String
  benefitId   String
  enabled     Boolean          @default(true) // true = plano TEM este benefício
  customValue String?          // Valor customizado (ex: "10%" em vez do padrão)
  createdAt   DateTime         @default(now())
  plan        SubscriptionPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  benefit     Benefit          @relation(fields: [benefitId], references: [id], onDelete: Cascade)

  @@unique([planId, benefitId])
  @@index([planId])
  @@index([benefitId])
}

// ==========================================
// INFORMAÇÕES DE FRETE DO PEDIDO
// ==========================================

model OrderShippingInfo {
  id                String   @id @default(uuid())
  orderId           String   @unique
  carrier           String   // Ex: "Correios", "Jadlog"
  serviceCode       String   // Ex: "04014" (SEDEX)
  serviceName       String   // Ex: "SEDEX"
  estimatedDays     Int      // Prazo em dias úteis
  shippingCost      Decimal  @db.Decimal(10, 2)
  packageWeight     Decimal? @db.Decimal(10, 3) // kg
  packageDimensions Json?    // { width, height, length }
  quotedAt          DateTime // Quando a cotação foi feita
  createdAt         DateTime @default(now())
  order             Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
}

model Tag {
  id        String       @id @default(uuid())
  name      String
  slug      String       @unique
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  products  ProductTag[]

  @@index([slug])
}

model User {
  id            String           @id @default(uuid())
  fullName      String
  email         String           @unique
  passwordHash  String
  birthDate     DateTime?
  whatsapp      String?
  role          UserRole         @default(CUSTOMER)
  status        UserStatus       @default(ACTIVE)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  emailVerified DateTime?
  image         String?
  accounts      Account[]
  addresses     Address[]
  cart          Cart?
  orders        Order[]
  reviews       Review[]
  sessions      Session[]
  subscriptions Subscription[]
  preferences   UserPreferences?
  profile       UserProfile?
}

model UserPreferences {
  id                   String                @id @default(uuid())
  userId               String                @unique
  yearsSmoking         Int?
  favoritePaperType    PaperType?
  favoritePaperSize    PaperSize?
  paperFilterSize      FilterPaperSize?
  glassFilterSize      GlassFilterSize?
  glassFilterThickness GlassFilterThickness?
  favoriteColors       String[]
  tobaccoUsage         TobaccoUsage?
  consumptionFrequency ConsumptionFrequency?
  consumptionMoment    ConsumptionMoment[]
  consumesFlower       Boolean               @default(false)
  consumesSkunk        Boolean               @default(false)
  consumesHash         Boolean               @default(false)
  consumesExtracts     Boolean               @default(false)
  consumesOilEdibles   Boolean               @default(false)
  likesAccessories     Boolean               @default(false)
  likesCollectibles    Boolean               @default(false)
  likesPremiumItems    Boolean               @default(false)
  notes                String?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  user                 User                  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model UserProfile {
  id        String   @id @default(uuid())
  userId    String   @unique
  phone     String?
  document  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VariantOptionValue {
  id          String             @id @default(uuid())
  variantId   String
  optionValue String
  option      ProductOptionValue @relation(fields: [optionValue], references: [id], onDelete: Cascade)
  variant     ProductVariant     @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@unique([variantId, optionValue])
  @@index([optionValue])
  @@index([variantId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model ShippingProfile {
  id        String   @id @default(uuid())
  name      String
  weightKg  Decimal  @db.Decimal(6, 3)
  widthCm   Int
  heightCm  Int
  lengthCm  Int
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  products          Product[]
  subscriptionPlans SubscriptionPlan[]

  @@index([isActive])
}

model WebhookEvent {
  id         String          @id @default(uuid())
  provider   PaymentProvider
  eventType  String
  externalId String?
  payload    Json
  processed  Boolean         @default(false)
  createdAt  DateTime        @default(now())

  @@index([externalId])
  @@index([processed])
  @@index([provider])
}

enum BillingCycle {
  MONTHLY
  QUARTERLY
  SEMIANNUAL
  ANNUAL
}

enum CartStatus {
  ACTIVE
  ABANDONED
  CONVERTED
}

enum ConsumptionFrequency {
  OCCASIONAL
  WEEKLY
  DAILY
  HEAVY
}

enum ConsumptionMoment {
  MORNING
  AFTERNOON
  NIGHT
  WEEKEND
}

enum CycleStatus {
  PENDING
  PAID
  FAILED
  SKIPPED
}

enum DiscountType {
  PERCENT
  FIXED
}

enum FilterPaperSize {
  SHORT
  MEDIUM
  LONG
  ULTRA_LONG
  MIXED
}

enum GlassFilterSize {
  SHORT
  MEDIUM
  LONG
  MIXED
}

enum GlassFilterThickness {
  THIN
  MEDIUM
  THICK
  MIXED
}

enum OrderStatus {
  PENDING
  PAID
  CANCELED
  SHIPPED
  DELIVERED
}

enum PaperSize {
  MINI
  KING_SIZE_SLIM
  KING_SIZE_TRADITIONAL
  KING_SIZE_LONG
  MIXED
}

enum PaperType {
  WHITE
  BROWN
  CELLULOSE
  MIXED
}

enum PaymentProvider {
  MERCADO_PAGO
  STRIPE
  MANUAL
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum ProductStatus {
  DRAFT
  ACTIVE
  OUT_OF_STOCK
  DISCONTINUED
}

enum ShipmentStatus {
  PENDING
  LABEL_CREATED
  IN_TRANSIT
  DELIVERED
  LOST
  RETURNED
}

enum StockMode {
  SIMPLE
  VARIANT
}

enum StockMovementType {
  IN
  OUT
  ADJUSTMENT
}

enum SubscriptionStatus {
  ACTIVE
  PAUSED
  CANCELED
  PENDING_CANCELLATION
  EXPIRED
}

enum TobaccoUsage {
  FULL_TIME
  MIX_ONLY
  NONE
}

enum UserRole {
  ADMIN
  CUSTOMER
}

enum UserStatus {
  ACTIVE
  BLOCKED
}
